# Implementation Plan: Shared Finance Workspace

**Branch**: `021-shared-workspace` | **Date**: 2025-12-26 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/021-shared-workspace/spec.md`

## Summary

Transition the application from a user-centric data model to a workspace-centric model. **Crucially, the Workspace becomes the primary source of truth for all financial data, including FixedCosts, CurrentBalance, and WealthProfile configurations.** This allows multiple users to access and manage the same financial data with peer-to-peer permissions. The implementation includes workspace creation/naming, a one-time use invite system with email notifications via Mailjet, a destructive join flow with high-friction warnings, and user offboarding/revocation logic.

## Technical Context

**Language/Version**: Go 1.17+ (Backend), JavaScript (Vue 3.3.4) (Frontend)
- **Primary Dependencies**: Gin (Router), GORM (ORM) for Backend; Vuetify 3.3.15, Vue Router 4.2+, Chart.js 4.4.0 for Frontend.
**Storage**: PostgreSQL 15+ (GORM managed)
**Testing**: Go standard testing + testify (Backend), Vitest + Vue Test Utils (Frontend).
**Target Platform**: Linux (Docker/Cloud Run)
**Project Type**: Web application (Frontend + Backend)
**Performance Goals**: API latency < 200ms for workspace operations; real-time access revocation.
**Resources**:
- **Email Template**: Utilizing the existing template at `/backend/templates/invite_email.html` for workspace invitations.
- **UI Base**: Functionality will be integrated into the existing user profile settings page at `frontend/src/components/settings/UserSettingsPage.vue`.
**Constraints**: 
- 60% test coverage mandate (Constitution IV).
- Fintech Dark Mode aesthetic (Constitution VII).
- Page-Centric Frontend Architecture (Constitution VIII).
- Data loss must be confirmed and transactional (Constitution VI).
**Scale/Scope**: Support multiple users per workspace; infinite horizontal scaling of workspaces.

## Migration Strategy

Since this is a breaking change for the database structure, a solid migration strategy is required to ensure no data loss and seamless access for existing users:

1.  **Schema Evolution**: Introduce `workspaces` table and `workspace_users` junction table. Add `workspace_id` foreign key to `fixed_costs`, `wealth_profiles`, etc.
2.  **Data Migration (Rollout)**:
    -   Create a database migration script that runs on deployment.
    -   For every existing user in `users` table:
        -   Create a new default `Workspace` (e.g., named "My Workspace").
        -   Associate the user as the `OWNER` of this new workspace.
        -   Update all their existing records (costs, settings, etc.) to reference this new `workspace_id`.
3.  **Backward Compatibility**: The application logic will be updated to query by `workspace_id` instead of `user_id`.
4.  **User Experience**: Users will log in and see their data exactly as before, transparently scoped to their new personal workspace. They can then choose to invite others or rename their workspace.

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Simplicity First | Pass | Workspace-centric model is the simplest way to support multi-user sharing. |
| II. UX Excellence | Pass | High-friction modal for destructive join ensures user awareness. |
| III. Full-Stack Separation | Pass | Clear separation between workspace management API and frontend settings. |
| IV. Test Coverage | Pass | Plan includes unit and integration tests for new logic. |
| V. API-First Design | Pass | OpenAPI contracts will be defined in Phase 1. |
| VI. Data Integrity | Pass | Destructive operations require confirmation; transactions used for data migration. |
| VII. Visual Design | Pass | Settings page will follow Fintech Dark Mode. |
| VIII. Frontend Architecture | Pass | New components will be placed in `src/components/settings/`. |

## Project Structure

### Documentation (this feature)

```text
specs/021-shared-workspace/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
backend/
├── internal/
│   ├── api/             # Workspace and Invite handlers
│   ├── models/          # Workspace, Invite, and User model updates
│   ├── services/        # Workspace management and Email service
│   └── storage/         # DB migrations for new schema
└── tests/
    └── integration/     # Workspace flow tests

frontend/
├── src/
│   ├── components/
│   │   └── settings/    # Workspace management UI (Page-centric)
│   ├── services/        # Workspace and Invite API clients
│   └── router/          # Routes for settings and invite handling
└── tests/
    └── unit/            # Component and service tests
```

**Structure Decision**: Web application (Option 2) as it involves both Go backend and Vue frontend.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| N/A | | |